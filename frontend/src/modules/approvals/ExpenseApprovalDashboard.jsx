import React, { useState, useEffect } from 'react';\nimport { Link } from 'react-router-dom';\nimport {\n  Clock,\n  CheckCircle,\n  XCircle,\n  AlertTriangle,\n  DollarSign,\n  TrendingUp,\n  Users,\n  Calendar,\n  Eye,\n  Filter,\n  Search\n} from 'lucide-react';\nimport expenseApprovalService from '../../services/expenseApprovalService';\nimport { toast } from 'react-hot-toast';\n\nconst ExpenseApprovalDashboard = () => {\n  const [stats, setStats] = useState(null);\n  const [pendingApprovals, setPendingApprovals] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filters, setFilters] = useState({\n    priority: '',\n    approval_type: '',\n    amount_range: ''\n  });\n  const [pagination, setPagination] = useState({\n    currentPage: 1,\n    totalPages: 1,\n    totalItems: 0,\n    itemsPerPage: 10\n  });\n\n  useEffect(() => {\n    fetchData();\n  }, [pagination.currentPage, searchTerm, filters]);\n\n  const fetchData = async () => {\n    try {\n      setLoading(true);\n      \n      const [statsResponse, approvalsResponse] = await Promise.all([\n        expenseApprovalService.getApprovalStats({ period: '30' }),\n        expenseApprovalService.getPendingApprovals({\n          page: pagination.currentPage,\n          limit: pagination.itemsPerPage,\n          search: searchTerm,\n          ...filters\n        })\n      ]);\n\n      setStats(statsResponse.data);\n      setPendingApprovals(approvalsResponse.data.approvals);\n      setPagination(approvalsResponse.data.pagination);\n    } catch (error) {\n      console.error('Error fetching approval data:', error);\n      toast.error('Failed to fetch approval data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSearch = (e) => {\n    setSearchTerm(e.target.value);\n    setPagination(prev => ({ ...prev, currentPage: 1 }));\n  };\n\n  const handleFilterChange = (key, value) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n    setPagination(prev => ({ ...prev, currentPage: 1 }));\n  };\n\n  const getPriorityBadge = (priority) => {\n    const priorityColors = {\n      urgent: 'bg-red-100 text-red-800',\n      high: 'bg-orange-100 text-orange-800',\n      medium: 'bg-yellow-100 text-yellow-800',\n      low: 'bg-green-100 text-green-800'\n    };\n    \n    return (\n      <span className={`px-2 py-1 text-xs font-medium rounded-full ${priorityColors[priority] || 'bg-gray-100 text-gray-800'}`}>\n        {priority?.toUpperCase()}\n      </span>\n    );\n  };\n\n  const getApprovalPathBadge = (path) => {\n    return (\n      <span className={`px-2 py-1 text-xs font-medium rounded-full ${\n        path === 'high_value' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'\n      }`}>\n        {path === 'high_value' ? 'High Value' : 'Standard'}\n      </span>\n    );\n  };\n\n  const formatCurrency = (amount, currency = 'NGN') => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: currency\n    }).format(amount / 100); // Convert from cents\n  };\n\n  if (loading && !stats) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4 mb-4\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6\">\n            {[...Array(4)].map((_, i) => (\n              <div key={i} className=\"h-24 bg-gray-200 rounded\"></div>\n            ))}\n          </div>\n          <div className=\"h-96 bg-gray-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Expense Approvals</h1>\n          <p className=\"text-gray-600\">Review and approve expense claims</p>\n        </div>\n      </div>\n\n      {/* Statistics Cards */}\n      {stats && (\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center\">\n              <div className=\"p-2 bg-blue-100 rounded-lg\">\n                <Clock className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div className=\"ml-4\">\n                <p className=\"text-sm font-medium text-gray-600\">Pending Approvals</p>\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.pending_approvals}</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center\">\n              <div className=\"p-2 bg-red-100 rounded-lg\">\n                <AlertTriangle className=\"h-6 w-6 text-red-600\" />\n              </div>\n              <div className=\"ml-4\">\n                <p className=\"text-sm font-medium text-gray-600\">Overdue</p>\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.overdue_approvals}</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center\">\n              <div className=\"p-2 bg-green-100 rounded-lg\">\n                <CheckCircle className=\"h-6 w-6 text-green-600\" />\n              </div>\n              <div className=\"ml-4\">\n                <p className=\"text-sm font-medium text-gray-600\">Approval Rate</p>\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.approval_rate}%</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center\">\n              <div className=\"p-2 bg-purple-100 rounded-lg\">\n                <DollarSign className=\"h-6 w-6 text-purple-600\" />\n              </div>\n              <div className=\"ml-4\">\n                <p className=\"text-sm font-medium text-gray-600\">Amount Approved</p>\n                <p className=\"text-2xl font-bold text-gray-900\">\n                  {formatCurrency(stats.total_amount_approved)}\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Search and Filters */}\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"flex flex-col space-y-4\">\n          <div className=\"flex flex-col sm:flex-row gap-4\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search by employee name, expense title, or amount...\"\n                value={searchTerm}\n                onChange={handleSearch}\n                className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n              />\n            </div>\n            <button className=\"flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50\">\n              <Filter className=\"h-4 w-4\" />\n              <span>Filters</span>\n            </button>\n          </div>\n\n          {/* Filter Options */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Priority</label>\n              <select\n                value={filters.priority}\n                onChange={(e) => handleFilterChange('priority', e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n              >\n                <option value=\"\">All Priorities</option>\n                <option value=\"urgent\">Urgent</option>\n                <option value=\"high\">High</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"low\">Low</option>\n              </select>\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Approval Type</label>\n              <select\n                value={filters.approval_type}\n                onChange={(e) => handleFilterChange('approval_type', e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n              >\n                <option value=\"\">All Types</option>\n                <option value=\"standard\">Standard</option>\n                <option value=\"high_value\">High Value</option>\n              </select>\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Amount Range</label>\n              <select\n                value={filters.amount_range}\n                onChange={(e) => handleFilterChange('amount_range', e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n              >\n                <option value=\"\">All Amounts</option>\n                <option value=\"0-10000\">Under ₦100</option>\n                <option value=\"10000-50000\">₦100 - ₦500</option>\n                <option value=\"50000-100000\">₦500 - ₦1,000</option>\n                <option value=\"100000+\">Over ₦1,000</option>\n              </select>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Pending Approvals List */}\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"px-6 py-4 border-b border-gray-200\">\n          <h3 className=\"text-lg font-medium text-gray-900\">\n            Pending Approvals ({pagination.totalItems})\n          </h3>\n        </div>\n\n        {loading ? (\n          <div className=\"p-6\">\n            <div className=\"animate-pulse space-y-4\">\n              {[...Array(5)].map((_, i) => (\n                <div key={i} className=\"flex items-center space-x-4\">\n                  <div className=\"h-12 w-12 bg-gray-200 rounded-full\"></div>\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"h-4 bg-gray-200 rounded w-1/4\"></div>\n                    <div className=\"h-3 bg-gray-200 rounded w-1/3\"></div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        ) : pendingApprovals.length === 0 ? (\n          <div className=\"p-6 text-center\">\n            <CheckCircle className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No pending approvals</h3>\n            <p className=\"text-gray-600\">\n              All expense claims have been reviewed. Great job!\n            </p>\n          </div>\n        ) : (\n          <div className=\"divide-y divide-gray-200\">\n            {pendingApprovals.map((approval) => (\n              <div key={approval.id} className=\"p-6 hover:bg-gray-50\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"flex-shrink-0\">\n                      <div className=\"h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center\">\n                        <Users className=\"h-5 w-5 text-gray-600\" />\n                      </div>\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center space-x-2 mb-1\">\n                        <h4 className=\"text-sm font-medium text-gray-900 truncate\">\n                          {approval.expense_claim.title}\n                        </h4>\n                        {getPriorityBadge(approval.priority)}\n                        {getApprovalPathBadge(approval.expense_claim.approval_path)}\n                      </div>\n                      <div className=\"flex items-center space-x-4 text-sm text-gray-600\">\n                        <span>By: {approval.expense_claim.employee.name}</span>\n                        <span>•</span>\n                        <span>{formatCurrency(approval.expense_claim.amount, approval.expense_claim.currency)}</span>\n                        <span>•</span>\n                        <span>{approval.expense_claim.expense_type.replace('_', ' ')}</span>\n                        <span>•</span>\n                        <span>{approval.days_pending} days pending</span>\n                      </div>\n                      <div className=\"flex items-center space-x-2 mt-1\">\n                        <Calendar className=\"h-3 w-3 text-gray-400\" />\n                        <span className=\"text-xs text-gray-500\">\n                          Expense Date: {new Date(approval.expense_claim.expense_date).toLocaleDateString()}\n                        </span>\n                        {approval.due_date && (\n                          <>\n                            <span className=\"text-xs text-gray-400\">•</span>\n                            <span className={`text-xs ${\n                              new Date(approval.due_date) < new Date() ? 'text-red-600' : 'text-gray-500'\n                            }`}>\n                              Due: {new Date(approval.due_date).toLocaleDateString()}\n                            </span>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <Link\n                      to={`/approvals/expenses/${approval.expense_claim.id}`}\n                      className=\"inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n                    >\n                      <Eye className=\"h-4 w-4 mr-2\" />\n                      Review\n                    </Link>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n\n        {/* Pagination */}\n        {pagination.totalPages > 1 && (\n          <div className=\"px-6 py-4 border-t border-gray-200\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"text-sm text-gray-700\">\n                Showing {((pagination.currentPage - 1) * pagination.itemsPerPage) + 1} to{' '}\n                {Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)} of{' '}\n                {pagination.totalItems} results\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <button\n                  onClick={() => setPagination(prev => ({ ...prev, currentPage: prev.currentPage - 1 }))}\n                  disabled={pagination.currentPage === 1}\n                  className=\"p-2 border border-gray-300 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50\"\n                >\n                  Previous\n                </button>\n                <span className=\"px-3 py-1 text-sm\">\n                  Page {pagination.currentPage} of {pagination.totalPages}\n                </span>\n                <button\n                  onClick={() => setPagination(prev => ({ ...prev, currentPage: prev.currentPage + 1 }))}\n                  disabled={pagination.currentPage === pagination.totalPages}\n                  className=\"p-2 border border-gray-300 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50\"\n                >\n                  Next\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default ExpenseApprovalDashboard;