import React, { useState } from \"react\";\nimport { Link } from \"react-router-dom\";\nimport { useQuery } from \"react-query\";\nimport {\n  Plus,\n  Calendar,\n  Users,\n  Banknote,\n  Grid3X3,\n  List,\n  BarChart3,\n  Eye,\n  Edit,\n  MoreVertical,\n  Settings,\n  Trash2\n} from \"lucide-react\";\nimport { projectService } from \"@/services/projectService\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { selectApiData } from \"@/services/api\";\nimport { formatCurrency } from \"@/utils/formatters\";\nimport toast from 'react-hot-toast';\n\nconst ProjectsFixed = () => {\n  const [viewMode, setViewMode] = useState(\"grid\"); // 'grid' or 'list'\n  const [filters, setFilters] = useState({\n    search: \"\",\n    status: [],\n    priority: [],\n    manager_id: [],\n    department_id: [],\n    budget_range: \"\",\n    progress_range: \"\",\n    start_date_from: \"\",\n    start_date_to: \"\",\n    end_date_from: \"\",\n    end_date_to: \"\",\n    is_billable: \"\",\n    sort: \"created_at_desc\",\n  });\n  \n  const {\n    isAuthenticated,\n    user,\n    token,\n    isLoading: authLoading,\n  } = useAuth();\n\n  // If auth is still loading, show loading state\n  if (authLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-300 rounded w-1/4 mb-4\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {Array.from({ length: 6 }).map((_, index) => (\n              <div key={index} className=\"bg-white rounded-lg shadow p-6\">\n                <div className=\"h-6 bg-gray-300 rounded w-3/4 mb-2\"></div>\n                <div className=\"h-4 bg-gray-300 rounded w-1/2 mb-4\"></div>\n                <div className=\"h-2 bg-gray-300 rounded w-full mb-4\"></div>\n                <div className=\"flex justify-between\">\n                  <div className=\"h-4 bg-gray-300 rounded w-1/4\"></div>\n                  <div className=\"h-4 bg-gray-300 rounded w-1/4\"></div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const {\n    data: projects,\n    isLoading,\n    error,\n    refetch,\n  } = useQuery(\n    [\"projects\", filters],\n    () => projectService.getProjects(filters),\n    {\n      enabled: isAuthenticated && !!token,\n      select: selectApiData,\n      keepPreviousData: true,\n      retry: 1,\n      refetchOnWindowFocus: false,\n      staleTime: 5 * 60 * 1000,\n      onError: (error) => {\n        console.error('Projects API error:', error);\n        toast.error('Failed to load projects');\n      },\n      onSuccess: (data) => {\n        console.log('Projects data received:', data);\n      }\n    }\n  );\n\n  const getStatusColor = (status) => {\n    const colors = {\n      planning: \"bg-gray-100 text-gray-800\",\n      active: \"bg-green-100 text-green-800\",\n      on_hold: \"bg-yellow-100 text-yellow-800\",\n      completed: \"bg-blue-100 text-blue-800\",\n      cancelled: \"bg-red-100 text-red-800\",\n    };\n    return colors[status] || \"bg-gray-100 text-gray-800\";\n  };\n\n  const getPriorityColor = (priority) => {\n    const colors = {\n      low: \"bg-green-100 text-green-800\",\n      medium: \"bg-yellow-100 text-yellow-800\",\n      high: \"bg-orange-100 text-orange-800\",\n      critical: \"bg-red-100 text-red-800\",\n    };\n    return colors[priority] || \"bg-gray-100 text-gray-800\";\n  };\n\n  // Mock data for demonstration when API fails\n  const mockProjects = [\n    {\n      id: 1,\n      name: \"Website Redesign\",\n      code: \"WEB-2024-001\",\n      status: \"active\",\n      priority: \"high\",\n      start_date: \"2024-01-01\",\n      end_date: \"2024-02-15\",\n      progress_percentage: 75,\n      budget_allocated: 50000,\n      budget_spent: 37500,\n      manager: { first_name: \"John\", last_name: \"Doe\" },\n      department: { name: \"Development\" },\n      team_size: 5,\n    },\n    {\n      id: 2,\n      name: \"Mobile App Development\",\n      code: \"MOB-2024-001\",\n      status: \"active\",\n      priority: \"medium\",\n      start_date: \"2024-01-15\",\n      end_date: \"2024-03-30\",\n      progress_percentage: 45,\n      budget_allocated: 120000,\n      budget_spent: 54000,\n      manager: { first_name: \"Sarah\", last_name: \"Wilson\" },\n      department: { name: \"Development\" },\n      team_size: 8,\n    },\n    {\n      id: 3,\n      name: \"Database Migration\",\n      code: \"DB-2024-001\",\n      status: \"completed\",\n      priority: \"high\",\n      start_date: \"2023-12-01\",\n      end_date: \"2024-01-20\",\n      progress_percentage: 100,\n      budget_allocated: 25000,\n      budget_spent: 23000,\n      manager: { first_name: \"Mike\", last_name: \"Johnson\" },\n      department: { name: \"IT\" },\n      team_size: 3,\n    },\n  ];\n\n  const displayProjects = projects?.projects || mockProjects;\n\n  const handleRefresh = () => {\n    refetch();\n  };\n\n  // Simple Project Actions Component\n  const ProjectActions = ({ project }) => {\n    const [showDropdown, setShowDropdown] = useState(false);\n\n    return (\n      <div className=\"relative\">\n        <button\n          onClick={() => setShowDropdown(!showDropdown)}\n          className=\"p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100\"\n        >\n          <MoreVertical className=\"h-4 w-4\" />\n        </button>\n        \n        {showDropdown && (\n          <div className=\"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200\">\n            <div className=\"py-1\">\n              <Link\n                to={`/projects/${project.id}`}\n                className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100\"\n                onClick={() => setShowDropdown(false)}\n              >\n                <Eye className=\"h-4 w-4 mr-2\" />\n                View Details\n              </Link>\n              <Link\n                to={`/projects/${project.id}/edit`}\n                className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100\"\n                onClick={() => setShowDropdown(false)}\n              >\n                <Edit className=\"h-4 w-4 mr-2\" />\n                Edit Project\n              </Link>\n              <Link\n                to={`/projects/${project.id}/tasks`}\n                className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100\"\n                onClick={() => setShowDropdown(false)}\n              >\n                <Settings className=\"h-4 w-4 mr-2\" />\n                Manage Tasks\n              </Link>\n              <Link\n                to={`/projects/${project.id}/team`}\n                className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100\"\n                onClick={() => setShowDropdown(false)}\n              >\n                <Users className=\"h-4 w-4 mr-2\" />\n                Manage Team\n              </Link>\n              <div className=\"border-t border-gray-100 my-1\"></div>\n              <button\n                onClick={() => {\n                  setShowDropdown(false);\n                  toast.error('Delete functionality not implemented yet');\n                }}\n                className=\"flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50\"\n              >\n                <Trash2 className=\"h-4 w-4 mr-2\" />\n                Delete Project\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  // Only show error boundary if we don't have any projects data\n  if (error && !projects?.projects?.length && !displayProjects.length) {\n    return (\n      <div className=\"text-center py-12\">\n        <div className=\"mx-auto h-12 w-12 text-red-400 mb-4\">\n          <svg fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={1}\n              d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z\"\n            />\n          </svg>\n        </div>\n        <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n          Unable to Load Projects\n        </h3>\n        <p className=\"text-gray-600 mb-4\">\n          There was an error connecting to the server.\n        </p>\n        <p className=\"text-sm text-gray-500\">\n          Please check your connection and try again.\n        </p>\n        <div className=\"mt-6\">\n          <button\n            onClick={() => refetch()}\n            className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-600\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Projects</h1>\n          <div className=\"flex items-center space-x-2\">\n            <p className=\"text-gray-600\">Manage and track all your projects</p>\n            {error && displayProjects.length > 0 && (\n              <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800\">\n                Demo Mode\n              </span>\n            )}\n          </div>\n        </div>\n        <div className=\"flex items-center space-x-3\">\n          <Link\n            to=\"/projects/dashboard\"\n            className=\"inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50\"\n          >\n            <BarChart3 className=\"h-4 w-4 mr-2\" />\n            Dashboard\n          </Link>\n          <Link\n            to=\"/projects/new\"\n            className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary\"\n          >\n            <Plus className=\"h-4 w-4 mr-2\" />\n            New Project\n          </Link>\n        </div>\n      </div>\n\n      {/* View Controls */}\n      <div className=\"flex items-center justify-between bg-white rounded-lg shadow p-4\">\n        <div className=\"flex items-center space-x-4\">\n          <span className=\"text-sm font-medium text-gray-700\">\n            {displayProjects.length} project\n            {displayProjects.length !== 1 ? \"s\" : \"\"} found\n          </span>\n          {error && (\n            <span className=\"text-sm text-amber-600 bg-amber-50 px-2 py-1 rounded\">\n              Showing cached data\n            </span>\n          )}\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          <button\n            onClick={() => setViewMode(\"grid\")}\n            className={`p-2 rounded-md ${\n              viewMode === \"grid\"\n                ? \"bg-blue-100 text-primary\"\n                : \"text-gray-400 hover:text-gray-600\"\n            }`}\n          >\n            <Grid3X3 className=\"h-4 w-4\" />\n          </button>\n          <button\n            onClick={() => setViewMode(\"list\")}\n            className={`p-2 rounded-md ${\n              viewMode === \"list\"\n                ? \"bg-blue-100 text-primary\"\n                : \"text-gray-400 hover:text-gray-600\"\n            }`}\n          >\n            <List className=\"h-4 w-4\" />\n          </button>\n          <button\n            onClick={handleRefresh}\n            className=\"p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100\"\n            title=\"Refresh\"\n          >\n            <svg className=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n            </svg>\n          </button>\n        </div>\n      </div>\n\n      {/* Projects Display */}\n      <div\n        className={\n          viewMode === \"grid\"\n            ? \"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\"\n            : \"space-y-4\"\n        }\n      >\n        {isLoading\n          ? // Loading skeleton\n            Array.from({ length: 6 }).map((_, index) => (\n              <div\n                key={index}\n                className=\"bg-white rounded-lg shadow p-6 animate-pulse\"\n              >\n                <div className=\"h-6 bg-gray-300 rounded w-3/4 mb-2\"></div>\n                <div className=\"h-4 bg-gray-300 rounded w-1/2 mb-4\"></div>\n                <div className=\"h-2 bg-gray-300 rounded w-full mb-4\"></div>\n                <div className=\"flex justify-between\">\n                  <div className=\"h-4 bg-gray-300 rounded w-1/4\"></div>\n                  <div className=\"h-4 bg-gray-300 rounded w-1/4\"></div>\n                </div>\n              </div>\n            ))\n          : displayProjects.map((project) =>\n              viewMode === \"grid\" ? (\n                // Grid View\n                <div\n                  key={project.id}\n                  className=\"bg-white rounded-lg shadow hover:shadow-md transition-shadow\"\n                >\n                  <div className=\"p-6\">\n                    <div className=\"flex items-start justify-between mb-4\">\n                      <div className=\"flex-1\">\n                        <Link\n                          to={`/projects/${project.id}`}\n                          className=\"text-lg font-semibold text-gray-900 hover:text-primary\"\n                        >\n                          {project.name}\n                        </Link>\n                        <p className=\"text-sm text-gray-500\">{project.code}</p>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <span\n                          className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(\n                            project.status\n                          )}`}\n                        >\n                          {project.status.replace(\"_\", \" \")}\n                        </span>\n                        <ProjectActions project={project} />\n                      </div>\n                    </div>\n\n                    {/* Progress */}\n                    <div className=\"mb-4\">\n                      <div className=\"flex items-center justify-between text-sm text-gray-600 mb-1\">\n                        <span>Progress</span>\n                        <span>{project.progress_percentage}%</span>\n                      </div>\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                        <div\n                          className=\"bg-primary h-2 rounded-full\"\n                          style={{ width: `${project.progress_percentage}%` }}\n                        ></div>\n                      </div>\n                    </div>\n\n                    {/* Project Info */}\n                    <div className=\"space-y-2 text-sm text-gray-600\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center\">\n                          <Calendar className=\"h-4 w-4 mr-2\" />\n                          <span>\n                            Due:{\" \"}\n                            {new Date(project.end_date).toLocaleDateString()}\n                          </span>\n                        </div>\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getPriorityColor(\n                            project.priority\n                          )}`}\n                        >\n                          {project.priority}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center\">\n                          <Users className=\"h-4 w-4 mr-2\" />\n                          <span>{project.team_size || 0} members</span>\n                        </div>\n                        <div className=\"flex items-center\">\n                          <Banknote className=\"h-4 w-4 mr-1\" />\n                          <span>\n                            {formatCurrency(project.budget_spent || 0)}\n                          </span>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center\">\n                        <span className=\"text-gray-500\">Manager:</span>\n                        <span className=\"ml-2\">\n                          {project.Manager?.User?.first_name ||\n                            project.manager?.first_name}{\" \"}\n                          {project.Manager?.User?.last_name ||\n                            project.manager?.last_name}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                // List View\n                <div\n                  key={project.id}\n                  className=\"bg-white rounded-lg shadow hover:shadow-md transition-shadow\"\n                >\n                  <div className=\"p-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center space-x-4 flex-1\">\n                        <div className=\"flex-1\">\n                          <Link\n                            to={`/projects/${project.id}`}\n                            className=\"text-lg font-semibold text-gray-900 hover:text-primary\"\n                          >\n                            {project.name}\n                          </Link>\n                          <p className=\"text-sm text-gray-500\">\n                            {project.code}\n                          </p>\n                        </div>\n\n                        <div className=\"flex items-center space-x-6\">\n                          <div className=\"text-center\">\n                            <p className=\"text-sm text-gray-500\">Status</p>\n                            <span\n                              className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(\n                                project.status\n                              )}`}\n                            >\n                              {project.status.replace(\"_\", \" \")}\n                            </span>\n                          </div>\n\n                          <div className=\"text-center\">\n                            <p className=\"text-sm text-gray-500\">Priority</p>\n                            <span\n                              className={`text-sm font-medium ${getPriorityColor(\n                                project.priority\n                              )}`}\n                            >\n                              {project.priority}\n                            </span>\n                          </div>\n\n                          <div className=\"text-center\">\n                            <p className=\"text-sm text-gray-500\">Progress</p>\n                            <div className=\"flex items-center space-x-2\">\n                              <div className=\"w-16 bg-gray-200 rounded-full h-2\">\n                                <div\n                                  className=\"bg-primary h-2 rounded-full\"\n                                  style={{\n                                    width: `${project.progress_percentage}%`,\n                                  }}\n                                ></div>\n                              </div>\n                              <span className=\"text-sm font-medium\">\n                                {project.progress_percentage}%\n                              </span>\n                            </div>\n                          </div>\n\n                          <div className=\"text-center\">\n                            <p className=\"text-sm text-gray-500\">Due Date</p>\n                            <p className=\"text-sm font-medium\">\n                              {new Date(project.end_date).toLocaleDateString()}\n                            </p>\n                          </div>\n\n                          <div className=\"text-center\">\n                            <p className=\"text-sm text-gray-500\">Budget</p>\n                            <p className=\"text-sm font-medium\">\n                              {formatCurrency(project.budget_spent || 0)}\n                            </p>\n                          </div>\n                        </div>\n                      </div>\n\n                      <ProjectActions project={project} />\n                    </div>\n                  </div>\n                </div>\n              )\n            )}\n      </div>\n\n      {/* Empty State */}\n      {!isLoading && displayProjects.length === 0 && (\n        <div className=\"text-center py-12 bg-white rounded-lg shadow\">\n          <div className=\"mx-auto h-12 w-12 text-gray-400\">\n            <svg fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={1}\n                d=\"M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"\n              />\n            </svg>\n          </div>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">\n            No projects found\n          </h3>\n          <p className=\"mt-1 text-sm text-gray-500\">\n            Get started by creating a new project.\n          </p>\n          <div className=\"mt-6\">\n            <Link\n              to=\"/projects/new\"\n              className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-600\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Project\n            </Link>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default ProjectsFixed;"